(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{251:function(t,e,a){"use strict";a.r(e);var s=a(19),n=Object(s.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"how-to-use-github-actions-to-deploy-a-virtual-machine"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how-to-use-github-actions-to-deploy-a-virtual-machine"}},[t._v("#")]),t._v(" How to use GitHub Actions to deploy a virtual machine")]),t._v(" "),a("ContentMeta"),t._v(" "),a("p",[t._v("Hands up if you are used to deploy servers either by unpacking them from a box or using a graphical user interface (GUI)? Yip, that’s me and it's where I’ve built my career. However, over the last few years I’ve been getting more and more used to deploying servers and their supporting resources via code. Either using something like PowerShell or Azure CLI, or sometimes a combination of both.")]),t._v(" "),a("p",[t._v("I’ve also taught myself how to use tools such as Visual Studio Code, Git, GitHub or even Azure DevOps to get the task done.  It’s not been an easy journey but what it has been is fun and a challenge.")]),t._v(" "),a("p",[t._v("At the end of 2019 GitHub announced "),a("a",{attrs:{href:"https://github.blog/2019-11-14-powering-community-led-innovation-with-github-actions/",target:"_blank",rel:"noopener noreferrer"}},[t._v("GitHub Actions"),a("OutboundLink")],1),t._v(", a new way to automate deployment of code from GitHub repositories.  I’ve been watching with interest as my developer focused colleagues and friends dig into the new service and show examples of it being used and have decided to take a look at it myself and see what it can do for the IT Pro community, as I’m a firm believer that these types of tools can offer IT Pros great opportunities as well.")]),t._v(" "),a("h2",{attrs:{id:"github-actions-terminology"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#github-actions-terminology"}},[t._v("#")]),t._v(" "),a("strong",[t._v("GitHub Actions Terminology")])]),t._v(" "),a("p",[t._v("There is some new terminology that comes with GitHub Actions, so let’s define those before we dig in.")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("Action")]),t._v(" – these define what we can do, we can either get them from the marketplace (free) or build our own")]),t._v(" "),a("li",[a("strong",[t._v("Workflow")]),t._v(" – A collection of Environment variables, Jobs and Steps that are completed when an event happens")]),t._v(" "),a("li",[a("strong",[t._v("Jobs")]),t._v(" – What the workflow will do")]),t._v(" "),a("li",[a("strong",[t._v("Steps")]),t._v(" - A task undertaken by a Job using an Action")]),t._v(" "),a("li",[a("strong",[t._v("Event")]),t._v(" – Something that happens and triggers a workflow, e.g a commit is pushed to a repository, an issue or pull request is issued")])]),t._v(" "),a("h2",{attrs:{id:"what-do-you-want-to-build"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-do-you-want-to-build"}},[t._v("#")]),t._v(" "),a("strong",[t._v("What do you want to build?")])]),t._v(" "),a("p",[t._v("Keeping it simple, I want my GitHub Action to build a virtual machine (VM) within Azure. Keeping it really simple I want it to build the VM and it’s associated supporting technology (disk, network interface, virtual network, storage account, etc) within the same resource group.  This isn’t exactly best practice but is an easy example to start with and one that is well known/documented.")]),t._v(" "),a("p",[t._v("I can use four blocks of Azure CLI code to build the VM within Azure.  The first block of code helps log into my Azure subscription using an Azure Service Principal and perform the necessary steps to create the VM.")]),t._v(" "),a("div",{staticClass:"language-powershell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#region Login")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This logs into Azure with a Service Principal Account")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Logging in to Azure with a service principal..."')]),t._v("\naz login `\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("service"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("principal `\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("username "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$servicePrincipal")]),t._v(" `\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("password "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$servicePrincipalSecret")]),t._v(" `\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("tenant "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$servicePrincipalTenantId")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Done"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#endregion")]),t._v("\n")])])]),a("p",[t._v("The next section selects the correct subscription, just to be sure my resources go to the right place:")]),t._v(" "),a("div",{staticClass:"language-powershell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#region Subscription")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#This sets the subscription the resources will be created in")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Setting default azure subscription..."')]),t._v("\naz account "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),t._v(" `\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("subscription "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$azureSubscriptionName")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Done"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#endregion")]),t._v("\n")])])]),a("p",[t._v("The third section creates the resource group for my VM to live in:")]),t._v(" "),a("div",{staticClass:"language-powershell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#region Create Resource Group")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This creates the resource group used to house the VM")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Creating resource group '),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$resourceGroupName")]),t._v(" in region "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$resourceGroupNameRegion")]),t._v('..."')]),t._v("\naz "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("group")]),t._v(" create `\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("name "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$resourceGroupName")]),t._v(" `\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("location "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$resourceGroupNameRegion")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Done creating resource group"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#endregion")]),t._v("\n")])])]),a("p",[t._v("And the fourth section creates the VM within that resource group:")]),t._v(" "),a("div",{staticClass:"language-powershell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#region Create VM")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Create a VM in the resource group")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Creating VM..."')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    az vm create  `\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("resource"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("group")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$resourceGroupName")]),t._v(" `\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("name "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$serverName")]),t._v(" `\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("image win2016datacenter `\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("admin"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("username "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$adminLogin")]),t._v(" `\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("admin"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("password "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$adminPassword")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"VM already exists"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Done creating VM"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-Output")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#endregion")]),t._v("\n")])])]),a("p",[t._v("The code isn’t complex and is a well-known example you can see in a lot of Documentation and tutorials. Within my script I’ve used various parameters to allow me to store the information securely or pass it in from my workflow file.  You can find my full PowerShell script "),a("a",{attrs:{href:"https://gist.github.com/weeyin83/81e7a7bf3caf3d0bce787db5d562b47e?WT.mc_id=blog-itops-salean",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("h2",{attrs:{id:"how-do-i-instruct-the-action"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how-do-i-instruct-the-action"}},[t._v("#")]),t._v(" "),a("strong",[t._v("How do I instruct the Action?")])]),t._v(" "),a("p",[t._v("To kick off the VM build we construct a Workflow file. This is in the form of YAML. You can call your workflow file anything you want as long as it ends with. yml or .yaml as the extension type. It also needs to be stored within a specific directory within your GitHub repository - "),a("strong",[t._v(".github/workflows")])]),t._v(" "),a("p",[t._v("Your workflow file is split up into several sections, let’s look at each of them individually:")]),t._v(" "),a("h3",{attrs:{id:"metadata"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#metadata"}},[t._v("#")]),t._v(" "),a("strong",[t._v("Metadata")])]),t._v(" "),a("p",[t._v("We start off with some naming the workflow:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" GitHub for IT Pro CI/CD Pipeline\n")])])]),a("h3",{attrs:{id:"environment-variables"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#environment-variables"}},[t._v("#")]),t._v(" "),a("strong",[t._v("Environment variables:")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("OUTPUT_PATH")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $\n")])])]),a("h3",{attrs:{id:"triggers"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#triggers"}},[t._v("#")]),t._v(" "),a("strong",[t._v("Triggers")])]),t._v(" "),a("p",[t._v("We then instruct how the action will be "),a("a",{attrs:{href:"https://help.github.com/en/actions/automating-your-workflow-with-github-actions/workflow-syntax-for-github-actions#on",target:"_blank",rel:"noopener noreferrer"}},[t._v("triggered"),a("OutboundLink")],1),t._v("; I have set my action to start whenever something is pushed to the repository:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("push"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("h3",{attrs:{id:"jobs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jobs"}},[t._v("#")]),t._v(" "),a("strong",[t._v("Jobs")])]),t._v(" "),a("p",[t._v("Now we start to declare the jobs that our workflow will do, we have to start by declaring what platform our Workflow will run on (Linux, MacOS or Windows).")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("jobs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Deploy VM in Azure")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DeployVM")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runs-on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" windows"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("latest\n")])])]),a("h3",{attrs:{id:"steps"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#steps"}},[t._v("#")]),t._v(" "),a("strong",[t._v("Steps")])]),t._v(" "),a("p",[t._v("Now we can start with the steps within the workflow. The first step I’ve instructed my workflow to do a checkout. This takes the files/code from my repository and puts it into "),a("strong",[t._v("$github.workspace")]),t._v(" for my workflow to access it.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# checkout code from repo")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" checkout repo\n\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" actions/checkout\n")])])]),a("p",[t._v("The next step we have is one where we tell the workflow to look for the PowerShell script that helps to build the VM:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" look for ps1 file\n\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v("\n\n        ls '$\\IaC\\AzCLI'\n")])])]),a("p",[t._v("And the last step in our workflow is to deploy and provision the VM:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" provision virtual machine in azure\n\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("RESOURCE_GROUP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("githubitpro\n\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("RESOURCE_GROUP_REGION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" southcentralus\n\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("SERVER_NAME")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gihtubactions\n\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ADMIN_LOGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sarah\n\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n\n        powershell "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("command \"& '$\\IaC\\AzCLI\\vmcreation.ps1'\"\n\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("servicePrincipal $\n\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("servicePrincipalSecret $\n\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("servicePrincipalTenantId $\n\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("azureSubscriptionName $\n\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("resourceGroupName %RESOURCE_GROUP%\n\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("resourceGroupNameRegion %RESOURCE_GROUP_REGION%\n\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("serverName %SERVER_NAME%\n\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("adminLogin %ADMIN_LOGIN%\n\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("adminPassword $\n")])])]),a("p",[t._v("Now there is a lot to that step so let’s break down what we are doing even further:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" provision virtual machine in azure\n\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("RESOURCE_GROUP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("githubitpro\n\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("RESOURCE_GROUP_REGION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" southcentralus\n\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("SERVER_NAME")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gihtubactions\n\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ADMIN_LOGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sarah\n")])])]),a("p",[t._v("This first part is declaring some environment variables, here I am setting my Azure Resource Group name, the region I want the resource group to be deployed in, the name of my virtual machine (server) and the name of the admin login account that will be created for that VM.")]),t._v(" "),a("p",[t._v("The second stage of the step is telling my workflow to call my PowerShell script and pass in the following variables from the workflow and "),a("a",{attrs:{href:"https://help.github.com/en/actions/automating-your-workflow-with-github-actions/creating-and-using-encrypted-secrets",target:"_blank",rel:"noopener noreferrer"}},[t._v("GitHub Secrets store"),a("OutboundLink")],1),t._v(".  To allow GitHub Actions to deploy resources within my Azure Subscription I have created an Azure Service Principal. If you’ve never worked within them before I wrote an article covering how to create and work with them "),a("a",{attrs:{href:"https://techcommunity.microsoft.com/t5/itops-talk-blog/working-with-azure-service-principal-accounts/ba-p/1086961?WT.mc_id=blog-itopstalk-salean",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("div",{staticClass:"language-powershell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[t._v("run: >\n\n        powershell "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("command "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"& '$\\IaC\\AzCLI\\vmcreation.ps1'\"")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("servicePrincipal $\n\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("servicePrincipalSecret $\n\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("servicePrincipalTenantId $\n\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("azureSubscriptionName $\n\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("resourceGroupName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("RESOURCE_GROUP"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("resourceGroupNameRegion "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("RESOURCE_GROUP_REGION"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("serverName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("SERVER_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("adminLogin "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("ADMIN_LOGIN"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("adminPassword $\n")])])]),a("p",[t._v("For a full copy of this workflow file, you can find it "),a("a",{attrs:{href:"https://gist.github.com/weeyin83/b63d320cc814dee9aebb599b847d0a49",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("h2",{attrs:{id:"monitoring-the-github-action-running"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#monitoring-the-github-action-running"}},[t._v("#")]),t._v(" Monitoring the GitHub Action running")]),t._v(" "),a("p",[t._v("When the Action is running you can monitor its progress. When you navigate to your repository on the GitHub website you will see a tab called Actions, click into that will take you into the Workflow section. You can create new workflows, edit workflows and monitor the progress of the workflows running.")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gxcuf89792.i.lithium.com/t5/image/serverpage/image-id/163886i433300750608D8F9/image-size/large?v=1.0&px=999",alt:"undefined"}}),a("em",[t._v("GitHub Actions Tab")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gxcuf89792.i.lithium.com/t5/image/serverpage/image-id/163889iD61736851B0DA262/image-size/large?v=1.0&px=999",alt:"undefined"}}),a("em",[t._v("Monitoring GitHub Actions")])]),t._v(" "),a("p",[t._v("And once the workflow has completed you can check in your Azure subscription and hopefully see the resource created:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gxcuf89792.i.lithium.com/t5/image/serverpage/image-id/163887i4528F2147C235951/image-size/large?v=1.0&px=999",alt:"undefined"}}),a("em",[t._v("Azure Resources")])]),t._v(" "),a("h2",{attrs:{id:"things-to-think-about"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#things-to-think-about"}},[t._v("#")]),t._v(" Things to think about")]),t._v(" "),a("p",[t._v("My example workflow is a very basic one and the resource that I am deploying is a very basic one, however for me it was a great starting point to learn GitHub Actions. I’ve seen my colleagues use it for much more complex deployments and workflows, for example Aaron Powell is using it to "),a("a",{attrs:{href:"https://www.aaron-powell.com/posts/2019-12-17-implementing-github-actions-for-my-blog/",target:"_blank",rel:"noopener noreferrer"}},[t._v("deploy his blog"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("The "),a("a",{attrs:{href:"https://github.com/weeyin83/vm-actions",target:"_blank",rel:"noopener noreferrer"}},[t._v("repository"),a("OutboundLink")],1),t._v(" I created to test out this deployment is a public one and the output of my workflow is available for anyone logged in or not to GitHub to view, which displays certain information that could be considered as sensitive such as my Azure Subscription ID and more importantly the Public IP address of my VM, which gives people with bad intentions an easy attack surface.  So, if you are testing GitHub Actions please be aware of this and vigilant on what you deploy in Azure and how it is secured.")]),t._v(" "),a("p",[t._v("I've recorded a video of me walking through the code and each step, this video can be found here:\n"),a("a",{attrs:{href:"https://youtu.be/0kDr9OlAzlM",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://youtu.be/0kDr9OlAzlM"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("I’d love to hear how other IT Pros are using GitHub Actions to deploy infrastructure, so please do reach out and share your stories!")])],1)}),[],!1,null,null,null);e.default=n.exports}}]);